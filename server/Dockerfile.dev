FROM node:22-alpine

# Minimal dev image: only OS deps and init; source code and node_modules are mounted via docker-compose volumes
RUN apk add --no-cache dumb-init python3 make g++ libc6-compat

ARG NPM_REGISTRY
ENV npm_config_registry=${NPM_REGISTRY:-https://registry.npmjs.org/}
ENV npm_config_fetch_retries=5 \
    npm_config_fetch_retry_maxtimeout=120000 \
    npm_config_fetch_retry_mintimeout=2000 \
    npm_config_timeout=120000 \
    npm_config_audit=false \
    npm_config_fund=false \
    npm_config_cache=/tmp/.npm \
    npm_config_unsafe_perm=true

WORKDIR /app

# Do not copy sources; docker-compose mounts them. Keep container root to avoid permission issues on bind mounts.
EXPOSE 3000
ENTRYPOINT ["dumb-init", "--"]
CMD ["sh", "-c", "cd /app/server && [ -d node_modules ] || npm ci && npm run dev"]
