generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int         @id @default(autoincrement())
  email      String      @unique
  name       String?
  password   String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  chats      Chat[]
  mcpServers MCPServer[]
  memories   Memory[]
  settings   Settings?
}

model Chat {
  id        Int       @id @default(autoincrement())
  userId    Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  title     String?
  user      User      @relation(fields: [userId], references: [id])
  messages  Message[]
}

model Message {
  id           Int         @id @default(autoincrement())
  content      Json
  role         MessageRole @default(USER)
  chatId       Int
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  thoughts     Json?
  responseToId Int?        @unique
  chat         Chat        @relation(fields: [chatId], references: [id])
  responseTo   Message?    @relation("RequestResponse", fields: [responseToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  request      Message?    @relation("RequestResponse")
}

model Settings {
  id                          Int      @id @default(autoincrement())
  userId                      Int      @unique
  defaultProvider             String   @default("openai")
  defaultModel                String   @default("o3-mini")
  thinkingBudget              Int      @default(2048)
  responseBudget              Int      @default(8192)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  mcpAutoDiscovery            Boolean  @default(true)
  mcpDefaultTimeout           Int      @default(10000)
  mcpEnableDebugLogging       Boolean  @default(false)
  mcpMaxConcurrentConnections Int      @default(5)
  user                        User     @relation(fields: [userId], references: [id])
}

model MCPServer {
  id                         Int              @id @default(autoincrement())
  userId                     Int
  name                       String
  version                    String
  description                String?
  isEnabled                  Boolean          @default(true)
  status                     MCPServerStatus  @default(DISCONNECTED)
  lastConnected              DateTime?
  transportType              MCPTransportType
  transportCommand           String?
  transportArgs              Json?
  transportEnv               Json?
  transportBaseUrl           String?
  transportTimeout           Int?
  transportRetryAttempts     Int?
  transportSessionId         String?
  transportToolEndpoint      String?          @default("/call-tool")
  transportHealthEndpoint    String?          @default("/health")
  transportToolsEndpoint     String?          @default("/tools")
  transportResourcesEndpoint String?          @default("/resources")
  authType                   MCPAuthType      @default(NONE)
  authClientId               String?
  authClientSecret           String?
  authAuthUrl                String?
  authTokenUrl               String?
  authScopes                 Json?
  authApiKey                 String?
  authHeaderName             String?
  authToken                  String?
  configAutoConnect          Boolean          @default(false)
  configConnectionTimeout    Int              @default(10000)
  configMaxRetries           Int              @default(3)
  configRetryDelay           Int              @default(2000)
  configValidateCertificates Boolean          @default(true)
  configDebug                Boolean          @default(false)
  capabilities               Json?
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  user                       User             @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Memory {
  id        Int      @id @default(autoincrement())
  userId    Int
  key       String?
  content   String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, key])
}

enum MessageRole {
  USER
  AI
}

enum MCPServerStatus {
  CONNECTED
  DISCONNECTED
  CONNECTING
  ERROR
  UNKNOWN
}

enum MCPTransportType {
  STDIO
  SSE
  STREAMABLE_HTTP
}

enum MCPAuthType {
  NONE
  OAUTH
  APIKEY
  BEARER
}
